<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extremely Weeb - ÿßŸÑŸÖÿ¥ÿßŸáÿØÿ©</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #FF0055;
            --bg: #0f0f13;
            --card-bg: #1a1a20;
            --text: #ffffff;
            --success: #00ff88;
            --server-btn-bg: #25252e;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding-bottom: 50px;
        }

        /* --- Video Player --- */
        .video-container {
            width: 100%;
            position: relative; /* kept relative so it scrolls with the page (option A) */
            z-index: 100;
            background: #000;
            aspect-ratio: 16/9;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        .container { padding: 15px; }

        /* --- Header Info --- */
        .anime-title { font-size: 1.4rem; margin: 10px 0 5px; color: var(--primary); }
        .anime-ep-title { font-size: 0.9rem; color: #aaa; margin-bottom: 15px; }

        /* --- Server Selector (New Feature) --- */
        .servers-section {
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border: 1px solid #333;
        }

        .section-label { font-size: 0.8rem; color: #888; margin-bottom: 8px; display: block; }

        .server-list {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
            -webkit-overflow-scrolling: touch; /* smooth on mobile */
            scrollbar-width: none; /* Hide scrollbar for cleaner look */
        }
        
        .server-btn {
            background: var(--server-btn-bg);
            border: 1px solid #444;
            border-radius: 6px;
            padding: 8px 12px;
            color: white;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
            font-size: 0.85rem;
        }

        .server-btn img {
            width: 16px;
            height: 16px;
            object-fit: contain;
        }

        .server-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(255, 0, 85, 0.4);
        }

        /* --- Episode List --- */
        .ep-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .ep-btn {
            background: var(--card-bg);
            border: 1px solid #333;
            padding: 12px 15px;
            border-radius: 8px;
            color: white;
            text-align: right;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ep-btn:active, .ep-btn.active {
            background: #2a2a35;
            border-left: 4px solid var(--primary);
        }

        .ep-num { font-weight: bold; font-size: 1rem; }
        
        /* Checkmark */
        .status-icon { display: none; }
        .ep-btn.watched .status-icon { display: block; }

        /* Back Button */
        .back-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.6);
            padding: 8px 12px;
            border-radius: 5px;
            color: white;
            text-decoration: none;
            z-index: 101;
            font-size: 0.9rem;
            backdrop-filter: blur(4px);
        }

        /* Fullscreen / External buttons (kept unobtrusive) */
        .fullscreen-btn, .external-btn{
          position: absolute;
          left: 12px; /* left because page is RTL */
          top: 12px;
          z-index: 120;
          background: rgba(0,0,0,0.6);
          color: #fff;
          border: none;
          padding: 8px 10px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 1rem;
          backdrop-filter: blur(4px);
          margin-left: 6px;
        }
        .external-btn { left: 72px; } /* offset to the right of fullscreen button */
        .fullscreen-btn:active, .external-btn:active { transform: scale(0.98); }

        /* Optional: show a subtle scrollbar on webkit */
        .server-list::-webkit-scrollbar { height: 8px; }
        .server-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 6px; }

    </style>
</head>
<body>

    <a href="index.html" class="back-btn">üè† ÿßŸÑŸÇÿßÿ¶ŸÖÿ©</a>

    <div class="video-container">
        <iframe id="main-player" src="" allow="fullscreen; autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
        <button id="fullscreen-btn" class="fullscreen-btn" aria-label="Fullscreen">‚§¢</button>
        <button id="external-btn" class="external-btn" aria-label="Open externally" style="display:none;">üåê ÿßŸÅÿ™ÿ≠ ÿ®ÿßŸÑÿÆÿßÿ±ÿ¨</button>
    </div>

    <div class="container">
        <h1 class="anime-title" id="anime-title">Loading...</h1>
        <div class="anime-ep-title" id="current-ep-label">ÿßÿÆÿ™ÿ± ÿ≠ŸÑŸÇÿ© ŸÑŸÑÿ®ÿØÿ°</div>

        <div class="servers-section" id="servers-box" style="display:none;">
            <span class="section-label">ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±ÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©:</span>
            <div class="server-list" id="server-list">
                </div>
        </div>

        <h3>ÿßŸÑÿ≠ŸÑŸÇÿßÿ™</h3>
        <div class="ep-list" id="ep-list">
            </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        if (tg && typeof tg.expand === 'function') tg.expand();

        // ---------------------------------------------------------
        // 1. DATABASE (JSON Structure)
        // ---------------------------------------------------------
        
        // Icon Links for Servers (You can change these urls)
        const icons = {
            "OK.ru": "https://i.im.ge/2026/02/02/e2wQA9.ok-ru-logo.png",
            mega: "https://upload.wikimedia.org/wikipedia/commons/f/f3/MEGA_logo.svg",
            vidstream: "https://cdn-icons-png.flaticon.com/512/2620/2620579.png",
            default: "https://cdn-icons-png.flaticon.com/512/565/565296.png"
        };

// Complete Anime Data
const db = {
    "AzumangaDaioh": {
        title: "Azumanga Daioh",
        episodes: [
            {
                id: 1, 
                title: "ÿ∑ÿßŸÑÿ®ÿ© ÿ∑ŸÅŸÑÿ© ŸÅŸä ÿßŸÑŸÖÿØÿ±ÿ≥ÿ© ÿßŸÑÿ´ÿßŸÜŸàŸäÿ© / ÿ•ŸÜŸáÿß ŸÖÿπÿ¨ÿ≤ÿ© / ÿ±ÿ®ŸÖÿß ŸÖÿÆŸäŸÅÿ©ÿü / ÿßŸÑŸÇÿ∑ ÿßŸÑÿ®ÿ±Ÿä ÿ™ŸàŸÖŸà ÿ™ÿ¥ÿßŸÜ!", 
                servers: [
                    {
                        name: "OK.ru",
                        icon: icons["OK.ru"], 
                        url: "https://ok.ru/videoembed/11551113022030?nochat=1"
                    }
                ]
            },
            {
                id: 2, 
                title: "ÿßŸÑÿßŸÉÿßÿ™ÿ≥ŸÉŸä ÿ™ÿ™ÿ≠ÿ±ŸÉ", 
                servers: [
                    {
                        name: "OK.ru",
                        icon: icons["OK.ru"], 
                        url: "https://ok.ru/video/11551280335438"
                    },
                ]
            }
            // Add more episodes here...
        ]
    },
    "onepiece": {
        title: "One Piece",
        episodes: [
            {
                id: 1,
                title: "ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ±ÿ≠ŸÑÿ©",
                servers: [
                    {
                        name: "FastServer",
                        icon: icons.default, 
                        url: "https://www.youtube.com/embed/S8_YwFLCh4U"
                    }
                ]
            }
        ]
    }
};

        // ---------------------------------------------------------
        // 2. INITIALIZATION
        // ---------------------------------------------------------

        const urlParams = new URLSearchParams(window.location.search);
        const animeId = urlParams.get('id') || 'naruto'; 
        const data = db[animeId];

        // Set Headers
        document.getElementById('anime-title').innerText = data ? data.title : "Anime Not Found";
        const player = document.getElementById('main-player');
        const epListContainer = document.getElementById('ep-list');
        const serverListContainer = document.getElementById('server-list');
        const serversBox = document.getElementById('servers-box');

        // Render Episode List
        if (data) {
            data.episodes.forEach((ep, index) => {
                const btn = document.createElement('div');
                btn.className = 'ep-btn';
                btn.id = `ep-btn-${ep.id}`;
                btn.innerHTML = `
                    <div class="ep-info">
                        <span class="ep-num">ÿßŸÑÿ≠ŸÑŸÇÿ© ${ep.id}</span>
                    </div>
                    <div class="status-icon">‚úÖ</div>
                `;
                
                // Click: Select Episode
                btn.onclick = () => selectEpisode(ep, btn);
                epListContainer.appendChild(btn);
            });
        }

        // ---------------------------------------------------------
        // 3. LOGIC FUNCTIONS
        // ---------------------------------------------------------

        function selectEpisode(episodeData, btnElement) {
            // 1. UI: Highlight active episode
            document.querySelectorAll('.ep-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');

            // 2. UI: Show Server Section
            serversBox.style.display = 'block';
            document.getElementById('current-ep-label').innerText = `ÿßŸÑÿ≠ŸÑŸÇÿ© ${episodeData.id}: ${episodeData.title}`;

            // 3. Logic: Render Servers for this episode
            renderServers(episodeData.servers);

            // 4. Logic: Auto-play first server
            if (episodeData.servers.length > 0) {
                changeServer(episodeData.servers[0].url, 0);
            }

            // 5. Save Progress
            markAsWatched(animeId, episodeData.id, btnElement);
        }

        function renderServers(servers) {
            serverListContainer.innerHTML = ''; // Clear old servers
            
            servers.forEach((server, index) => {
                const sBtn = document.createElement('button');
                sBtn.className = 'server-btn';
                sBtn.id = `server-btn-${index}`;
                
                // Icon + Name
                sBtn.innerHTML = `<img src="${server.icon}" alt=""> ${server.name}`;
                
                sBtn.onclick = () => changeServer(server.url, index);
                serverListContainer.appendChild(sBtn);
            });
        }

        function changeServer(url, btnIndex) {
            // Change Iframe
            player.src = url;

            // Highlight active server button
            document.querySelectorAll('.server-btn').forEach(b => b.classList.remove('active'));
            const activeBtn = document.getElementById(`server-btn-${btnIndex}`);
            if(activeBtn) activeBtn.classList.add('active');
        }

        function markAsWatched(animeId, epId, btnElement) {
            // Add checkmark visually
            btnElement.classList.add('watched');

            // Save Episode History
            const key = `extWeeb_${animeId}_watched`;
            let watched = JSON.parse(localStorage.getItem(key)) || [];
            if (!watched.includes(epId)) {
                watched.push(epId);
                localStorage.setItem(key, JSON.stringify(watched));
            }

            // Save "Last Watched" for Main Menu banner
            const resumeData = {
                id: animeId,
                title: data.title,
                season: 1, // You can make this dynamic if needed
                episode: epId,
                url: window.location.href // Saves page link
            };
            localStorage.setItem('extWeeb_lastWatch', JSON.stringify(resumeData));
        }

        // ---------------------------------------------------------
        // 3.b Fullscreen / External Open Helpers (tries fullscreen, falls back to opening externally)
        // ---------------------------------------------------------
        (function(){
          const fsBtn = document.getElementById('fullscreen-btn');
          const extBtn = document.getElementById('external-btn');

          // Detect Telegram WebApp environment (simple detection)
          const inTelegram = !!(window.Telegram && window.Telegram.WebApp);

          // Show external button if inside Telegram (useful fallback)
          if (inTelegram && extBtn) extBtn.style.display = 'inline-block';

          function openExternally(url) {
            if (!url) return;
            try {
              if (inTelegram && window.Telegram.WebApp && typeof window.Telegram.WebApp.openLink === 'function') {
                window.Telegram.WebApp.openLink(url);
                return;
              }
            } catch(e) {
              console.warn('tg.openLink failed', e);
            }
            try { window.open(url, '_blank', 'noopener'); }
            catch(e){ window.location.href = url; }
          }

          async function tryFullscreenOrFallback() {
            const src = player && player.src;
            if (!src) return;

            try {
              if (player.requestFullscreen) {
                await player.requestFullscreen();
                return;
              }
              if (player.webkitEnterFullscreen) {
                try { player.webkitEnterFullscreen(); return; } catch(e){}
              }
            } catch (err) {
              console.warn('requestFullscreen failed:', err);
            }

            openExternally(src);
          }

          if (fsBtn) fsBtn.addEventListener('click', tryFullscreenOrFallback, { passive: true });
          if (extBtn) extBtn.addEventListener('click', () => openExternally(player.src), { passive: true });

          // Keep external button enabled/disabled based on src attribute
          const observer = new MutationObserver(() => {
            if (!extBtn) return;
            if (player && player.src) {
              extBtn.style.opacity = 1;
              extBtn.disabled = false;
            } else {
              extBtn.style.opacity = 0.6;
              extBtn.disabled = true;
            }
          });
          if (player) observer.observe(player, { attributes: true, attributeFilter: ['src'] });
        })();

        // ---------------------------------------------------------
        // 4. ON LOAD: Restore History
        // ---------------------------------------------------------
        window.onload = () => {
            const key = `extWeeb_${animeId}_watched`;
            const watched = JSON.parse(localStorage.getItem(key)) || [];
            
            watched.forEach(epId => {
                const el = document.getElementById(`ep-btn-${epId}`);
                if (el) el.classList.add('watched');
            });
        };

    </script>
</body>
</html>
